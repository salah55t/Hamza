import json
import requests
import logging
from config import TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID

logger = logging.getLogger(__name__)

def send_telegram_alert(signal, volume, btc_dominance, eth_dominance):
    try:
        profit = round((signal['target'] / signal['price'] - 1) * 100, 2)
        loss = round((signal['stop_loss'] / signal['price'] - 1) * 100, 2)
        message = (
            f"ğŸŒŸ **ØªÙˆØµÙŠØ© ØªØ¯Ø§ÙˆÙ„ - {signal['symbol']}**\n"
            f"ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: ${signal['price']}\n"
            f"ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: ${signal['target']} (+{profit}%)\n"
            f"ğŸ›‘ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ${signal['stop_loss']} ({loss}%)\n"
            f"ğŸ”„ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ: ${signal['dynamic_stop_loss']}\n"
            f"âš–ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©/Ø§Ù„Ø¹Ø§Ø¦Ø¯: {signal['risk_reward_ratio']:.2f}\n"
        )
        reply_markup = {"inline_keyboard": [[{"text": "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "callback_data": "get_report"}]]}
        url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message, "parse_mode": "Markdown", "reply_markup": json.dumps(reply_markup)}
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            logger.info(f"{signal['symbol']}: ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­")
        else:
            logger.error(f"{signal['symbol']}: ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠØ©: {response.text}")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ send_telegram_alert: {e}")

def send_telegram_alert_special(message):
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message, "parse_mode": "Markdown"}
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            logger.info("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¬Ø§Ø­")
        else:
            logger.error(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø§Øµ: {response.text}")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ send_telegram_alert_special: {e}")
